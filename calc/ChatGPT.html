<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Portable Calculator</title>
  <style>
    :root{--bg:#0f1724;--panel:#0b1220;--accent:#10b981;--muted:#94a3b8;--btn:#111827}
    *{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#071026 0%,var(--bg) 100%);color:#e6eef6}
    .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:28px}
    .calculator{width:360px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);border-radius:16px;padding:18px;box-shadow:0 8px 30px rgba(2,6,23,0.6);}
    .display{background:var(--panel);padding:18px;border-radius:12px;color:#e6eef6;display:flex;flex-direction:column;gap:6px}
    .sub{color:var(--muted);font-size:13px;min-height:18px;opacity:.95}
    .out{font-size:28px;text-align:right;word-break:break-all}
    .keys{margin-top:14px;display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    button.key{padding:14px;border-radius:10px;border:0;background:linear-gradient(180deg,#0b1320,#071028);color:#dbeafe;font-size:18px;cursor:pointer;box-shadow:0 6px 12px rgba(2,6,23,0.6)}
    button.key.operator{background:linear-gradient(180deg,#0b2b1d,#072214);color:#ddf7ec}
    button.key.equals{grid-column:span 2;background:linear-gradient(180deg,var(--accent),#059669);color:#041014;font-weight:700}
    .small{font-size:13px;padding:10px}
    .history{max-height:90px;overflow:auto;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);font-size:13px;color:var(--muted)}
    .foot{display:flex;gap:8px;margin-top:12px;align-items:center;justify-content:space-between}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px 10px;border-radius:8px;color:var(--muted);cursor:pointer}
    @media (max-width:420px){.calculator{width:100%}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="calculator" role="application" aria-label="Calculator">
      <div class="display">
        <div class="sub" id="formula" aria-live="polite"></div>
        <div class="out" id="output" aria-live="assertive">0</div>
      </div>

      <div class="keys" role="group" aria-label="Calculator keys">
        <button class="key small" data-action="clear">C</button>
        <button class="key small" data-action="back">⌫</button>
        <button class="key small" data-action="percent">%</button>
        <button class="key operator" data-value="/">÷</button>

        <button class="key" data-value="7">7</button>
        <button class="key" data-value="8">8</button>
        <button class="key" data-value="9">9</button>
        <button class="key operator" data-value="*">×</button>

        <button class="key" data-value="4">4</button>
        <button class="key" data-value="5">5</button>
        <button class="key" data-value="6">6</button>
        <button class="key operator" data-value="-">−</button>

        <button class="key" data-value="1">1</button>
        <button class="key" data-value="2">2</button>
        <button class="key" data-value="3">3</button>
        <button class="key operator" data-value="+">+</button>

        <button class="key" data-value="0" style="grid-column:span 2">0</button>
        <button class="key" data-value=".">.</button>
        <button class="key equals" data-action="equals">=</button>
      </div>

      <div class="foot">
        <div class="history" id="history" aria-live="polite">No history yet</div>
        <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
          <button class="btn-ghost" id="copy">Copy</button>
          <button class="btn-ghost" id="reset">Reset</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const formulaEl = document.getElementById('formula');
      const outputEl = document.getElementById('output');
      const historyEl = document.getElementById('history');
      const keys = document.querySelectorAll('.key');
      const copyBtn = document.getElementById('copy');
      const resetBtn = document.getElementById('reset');

      let formula = '';
      let lastResult = null;
      let hist = [];

      function refresh() {
        formulaEl.textContent = formula || '';
        outputEl.textContent = formula ? formula : (lastResult !== null ? lastResult : '0');
      }

      function append(char){
        // prevent multiple dots in a number segment
        if (char === '.'){
          const parts = formula.split(/[^0-9.]/);
          if (parts[parts.length-1].includes('.')) return;
          if (formula==='' || /[^0-9.]$/.test(formula)) char = '0.';
        }
        formula += char;
        refresh();
      }

      function clearAll(){ formula=''; lastResult=null; refresh(); }

      function backspace(){ formula = formula.slice(0,-1); refresh(); }

      function percent(){
        if (!formula) return;
        try {
          const safe = toJS(formula);
          const val = evalSafe(safe);
          const p = val/100;
          lastResult = format(p);
          histPush(formula + ' % = ' + lastResult);
          formula=''; refresh();
        } catch(e){ outputEl.textContent='Error' }
      }

      function equals(){
        if (!formula) return;
        try{
          const js = toJS(formula);
          const val = evalSafe(js);
          lastResult = format(val);
          histPush(formula + ' = ' + lastResult);
          formula=''; refresh();
        }catch(e){ outputEl.textContent='Error' }
      }

      function histPush(s){
        hist.unshift(s);
        if (hist.length>6) hist.pop();
        historyEl.textContent = hist.join('\n');
      }

      function format(n){
        if (Number.isFinite(n)){
          return (Math.round(n * 1e12)/1e12).toString();
        }
        return String(n);
      }

      // convert visual operators to JS operators
      function toJS(expr){
        return expr.replace(/×/g,'*').replace(/÷/g,'/').replace(/–/g,'-').replace(/−/g,'-');
      }

      // safe eval: allow numbers, parentheses, operators +-*/%. and spaces
      function evalSafe(expr){
        // restrict characters
        if (!/^[0-9+\-*/().%\s]+$/.test(expr)) throw new Error('Invalid characters');
        // further remove accidental leading zeros? leave as is
        // use Function rather than eval to reduce scope risks
        // but still make sure only allowed chars are present
        // eslint-disable-next-line no-new-func
        return Function('return (' + expr + ')')();
      }

      keys.forEach(k=>{
        k.addEventListener('click', ()=>{
          const v = k.dataset.value;
          const action = k.dataset.action;
          if (action === 'clear') clearAll();
          else if (action === 'back') backspace();
          else if (action === 'percent') percent();
          else if (action === 'equals') equals();
          else if (v) append(v);
        });
      });

      // keyboard support
      window.addEventListener('keydown', (e)=>{
        if (e.key >= '0' && e.key <= '9') { append(e.key); e.preventDefault(); }
        else if (e.key === '.') { append('.'); e.preventDefault(); }
        else if (e.key === 'Enter' || e.key === '=') { equals(); e.preventDefault(); }
        else if (e.key === 'Backspace') { backspace(); }
        else if (e.key === 'Escape') { clearAll(); }
        else if (['+','-','*','/','(',')'].includes(e.key)) { append(e.key); e.preventDefault(); }
        else if (e.key === '%') { percent(); e.preventDefault(); }
      });

      copyBtn.addEventListener('click', ()=>{
        const text = lastResult !== null ? String(lastResult) : (formula || '0');
        navigator.clipboard && navigator.clipboard.writeText(text).then(()=>{
          copyBtn.textContent='Copied'; setTimeout(()=>copyBtn.textContent='Copy',900);
        }).catch(()=>{ copyBtn.textContent='Copy failed'; setTimeout(()=>copyBtn.textContent='Copy',900);
        });
      });

      resetBtn.addEventListener('click', ()=>{ hist=[]; historyEl.textContent='No history yet'; clearAll(); });

      // init
      refresh();
    })();
  </script>
</body>
</html>
